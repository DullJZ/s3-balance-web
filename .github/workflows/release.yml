name: Build and Release

on:
  # 手动触发
  workflow_dispatch:

  # 推送 tag 时触发（可选）
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: 清理 npm 缓存
        run: npm cache clean --force

      - name: 安装依赖
        run: npm install

      - name: 构建前端
        run: npm run build

      - name: 生成时间戳和版本信息
        id: version
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "release_name=release-$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "tag_name=release-$TIMESTAMP" >> $GITHUB_OUTPUT

          # 获取简短的 commit hash
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: 打包 dist 目录
        run: |
          cd dist
          tar -czf ../dist.tar.gz .
          cd ..
          zip -r dist.zip dist/

      - name: 创建 Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: ${{ steps.version.outputs.release_name }}
          body: |
            ## S3 Balance Web - 前端构建

            **构建时间**: ${{ steps.version.outputs.timestamp }}
            **提交哈希**: `${{ steps.version.outputs.short_sha }}`
            **提交信息**: ${{ github.event.head_commit.message }}

          draft: false
          prerelease: false

      - name: 上传 tar.gz 到 Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist.tar.gz
          asset_name: dist.tar.gz
          asset_content_type: application/gzip

      - name: 上传 zip 到 Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist.zip
          asset_name: dist.zip
          asset_content_type: application/zip
